<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Rock Paper Scissors</title>

    <!-- TODO usare socket importato e imporare la madonna giusta-->
    <script src="https://cdn.socket.io/4.3.2/socket.io.min.js" integrity="sha384-KAZ4DtjNhLChOB/hxXuKqhMLYvx3b5MlT55xPEiNmREKRzeEm+RVPlTnAn0ajQNs" crossorigin="anonymous"></script>
</head>
<body>
    <h1>Rock - Paper - Scissors </h1>

    <div id="sign-up-container">
        <h2>Sign up</h2>
        <input id="nickname-input" type="text" name="nickname"/>
        <button id="submit-nickname-btn">Sign up!</button>
    </div>

    <div id="join-container">
        <h2>Join game</h2>
        <button id="join-game-btn">Join game!</button>
    </div>

    <div id="game-container">
        <h2>Play game</h2>
        You are playing against <span id="opponent-name"></span>
        <input type="radio" name="move" value="rock">rock!</input>
        <input type="radio" name="move" value="paper">paper!</input>
        <input type="radio" name="move" value="scissor">scissor!</input>
        <button id="submit-move">Play</button>
    </div>
</body>
<script>
    const API_BASE_URL = 'http://localhost:3000';
    const WS_URL = 'http://localhost:3000';

    main();

    function main() {
        attachEventListeners();
    }

    // Attach event listeners after rendering
    function attachEventListeners() {
        // const nicknameInput = document.getElementById('nickname-input');
        const submitNicknameBtn = document.getElementById('submit-nickname-btn');

        if (submitNicknameBtn) {
            submitNicknameBtn.addEventListener('click', handleNicknameSubmit);
        }

        const joinGameBtn = document.getElementById('join-game-btn');
        if (joinGameBtn) {
            joinGameBtn.addEventListener('click', handleJoinGame);
        }

        // const moveBtns = document.querySelectorAll('.move-btn');
        // moveBtns.forEach(function(btn) {
        //     btn.addEventListener('click', function() {
        //         const move = btn.getAttribute('data-move');
        //         handleMoveSelect(move);
        //     });
        // });
        //
        // const playAgainBtn = document.getElementById('play-again-btn');
        // if (playAgainBtn) {
        //     playAgainBtn.addEventListener('click', handlePlayAgain);
        // }
    }

    // Handle nickname submission
    async function handleNicknameSubmit() {
        const input = document.getElementById('nickname-input');
        const nickname = input.value.trim();

        if (!nickname)  {
            console.log('No nickname');
        }

        try {
            const response = await fetch(API_BASE_URL + '/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nickname: nickname })
            });

            const data = await response.json();
            console.log(data)
            // state.nickname = nickname;
            // state.sessionId = data.sessionId;
            // state.screen = 'lobby';
            // render();
        } catch (error) {
            console.error('Error logging in:', error);
        }
    }

    // Handle joining a game
    async function handleJoinGame() {
      initializeWebSocket()
        // try {
        //     const response = await fetch(API_BASE_URL + '/games/join', {
        //         method: 'POST',
        //         // headers: {
        //         //     'Content-Type': 'application/json',
        //         //     'Authorization': 'Bearer ' + state.sessionId
        //         // }
        //     });
        //
        //     const data = await response.json();
        //     console.log(data)
        //     // state.gameId = data.gameId;
        //     // state.waitingForOpponent = !data.opponentFound;
        //
        //     // initializeWebSocket(data.gameId);
        //     initializeWebSocket();
        //
        //     // state.screen = 'game';
        //     // render();
        // } catch (error) {
        //     console.error('Error joining game:', error);
        // }
    }

    // Initialize WebSocket connection
    // function initializeWebSocket(gameId) {
    function initializeWebSocket() {
        // const ws = new WebSocket(WS_URL + '?gameId=' + gameId + '&sessionId=' + state.sessionId);
        const socket = io(WS_URL);
        socket.on('connect', function() {
            console.log('WebSocket connected');

            // socket.emit('events', { test: 'test' });
            // socket.emit('identity', 0, response =>
            //         console.log('Identity:', response),
            // );
        });

        socket.on('*', function(data) {
            console.error('WebSocket error:', error);
        });
        // ws.onmessage = function(event) {
        //     const message = JSON.parse(event.data);
        //
        //     switch (message.type) {
        //         // case 'opponent_joined':
        //         //     state.waitingForOpponent = false;
        //         //     state.timeLeft = 10;
        //         //     render();
        //         //     break;
        //         // case 'timer_update':
        //         //     state.timeLeft = message.timeLeft;
        //         //     render();
        //         //     break;
        //         // case 'game_result':
        //         //     state.gameResult = message.result;
        //         //     state.screen = 'result';
        //         //     render();
        //         //     break;
        //         default:
        //             console.log('Unknown message type:', message);
        //     }
        // };

        socket.on('exception', function(data) {
            console.error('WebSocket error:', error);
        });

        socket.on('disconnect', function() {
            console.log('WebSocket disconnected');
        });

        // state.ws = ws;
    }

    // Send move to backend via WebSocket
    // function handleMoveSelect(move) {
    //     if (state.selectedMove || state.waitingForOpponent) return;
    //
    //     state.selectedMove = move;
    //     render();
    //
    //     if (state.ws && state.ws.readyState === WebSocket.OPEN) {
    //         state.ws.send(JSON.stringify({
    //             type: 'player_move',
    //             move: move
    //         }));
    //     }
    // }
</script>
</html>